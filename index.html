<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Matching Card Game</title>
<style>
  /* ... 기존 CSS 동일 ... */

  .card {
    position: relative;
    width: 100%;
    aspect-ratio: 1/1;
    perspective: 1000px;
    cursor: pointer;
  }

  .card-inner {
    position: absolute;
    width: 100%;
    height: 100%;
    transition: transform 0.6s;
    transform-style: preserve-3d;
    transform: rotateY(0deg);
  }

  /* flipped 클래스 있으면 카드 앞면 보여줌 */
  .card.flipped .card-inner {
    transform: rotateY(180deg);
  }

  /* matched 카드에는 cursor:none 등 스타일 */
  .matched {
    cursor: default !important;
  }

  /* 카드 앞면/뒷면 스타일 동일 */
  /* ... */

</style>
</head>
<body>
  <!-- ... 기존 HTML 동일 ... -->

<script>
  let cardData = [];
  let matchedPairs = 0;
  let firstCard = null;
  let lockBoard = false;
  let timer = null;
  let remainingTime = 0;

  // 카드별 매치 여부 상태 저장용 Map
  const matchedMap = new Map();

  // 기존 shuffle, updateScore, updateTimer 함수 동일

  function createBoard(pairs) {
    gameBoard.innerHTML = "";
    matchedPairs = 0;
    firstCard = null;
    lockBoard = false;
    matchedMap.clear();
    updateScore();

    cardData = [];
    pairs.forEach((pair, index) => {
      const pairId = index + 1;
      cardData.push(
        { type: "word", content: pair.word, pairId },
        { type: "image", content: pair.image, pairId }
      );
    });

    shuffle(cardData);

    cardData.forEach((data, index) => {
      const card = document.createElement("div");
      card.classList.add("card");
      card.dataset.pairId = data.pairId;
      card.dataset.index = index;

      const inner = document.createElement("div");
      inner.classList.add("card-inner");

      const front = document.createElement("div");
      front.classList.add("card-front");

      if (data.type === "word") {
        front.textContent = data.content;
      } else {
        const img = document.createElement("img");
        img.src = data.content;
        front.appendChild(img);
      }

      const back = document.createElement("div");
      back.classList.add("card-back");
      const backImg = document.createElement("img");
      backImg.src = backImage;
      back.appendChild(backImg);

      inner.appendChild(back);
      inner.appendChild(front);
      card.appendChild(inner);
      gameBoard.appendChild(card);

      // 매치 상태 초기화
      matchedMap.set(card.dataset.index, false);

      card.addEventListener("click", () => handleCardClick(card));
    });
  }

  function handleCardClick(card) {
    if (lockBoard) return;

    const cardIndex = card.dataset.index;
    if (matchedMap.get(cardIndex)) return; // 이미 맞춘 카드면 무시
    if (card === firstCard) return;

    card.classList.add("flipped");

    if (!firstCard) {
      firstCard = card;
      return;
    }

    lockBoard = true;

    const isMatch = firstCard.dataset.pairId === card.dataset.pairId;

    if (isMatch) {
      // 매치 상태 업데이트
      matchedMap.set(firstCard.dataset.index, true);
      matchedMap.set(card.dataset.index, true);

      firstCard.classList.add("matched");
      card.classList.add("matched");

      matchedPairs++;
      updateScore();

      firstCard = null;
      lockBoard = false;

      if (matchedPairs === cardData.length / 2) {
        clearInterval(timer);
        setTimeout(() => {
          alert(`Good job! ${60 - remainingTime}초 걸렸어! 멋진걸!`);
        }, 300);
      }
    } else {
      // 틀린 경우 1초 후 다시 뒤집기
      setTimeout(() => {
        card.classList.remove("flipped");
        firstCard.classList.remove("flipped");
        firstCard = null;
        lockBoard = false;
      }, 1000);
    }
  }

  // 기존 loadCSVAndStart 함수 동일

  startBtn.addEventListener("click", loadCSVAndStart);
</script>
</body>
</html>
